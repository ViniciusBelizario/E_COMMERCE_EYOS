<main>
  <h2>Cadastro de Produto-Variação</h2>

  <form id="formPV" enctype="multipart/form-data">
    <label>Produto</label>
    <select id="produto_id" required></select>

    <label>Cor</label>
    <select id="cor_id" required></select>

    <label>Tamanho</label>
    <select id="tamanho_id" required></select>

    <label>Quantidade</label>
    <input id="quantidade" type="number" min="0" required />

    <label>Imagem (opcional)</label>
    <input id="imagem_var" type="file" accept="image/*" />

    <button type="submit">Cadastrar Variação</button>
  </form>

  <div class="table-container">
    <h3>Variações</h3>
    <table>
      <thead>
        <tr><th>ID</th><th>Produto</th><th>Cor</th><th>Tamanho</th><th>Qtd</th><th>Imagem</th><th>Ações</th></tr>
      </thead>
      <tbody id="pvList"></tbody>
    </table>
  </div>
</main>

<script type="module">
  import { apiJson, apiMultipart } from "/js/api.js";

  async function carregarCombos() {
    const [produtos, cores, tamanhos] = await Promise.all([
      apiJson("/produtos"),
      apiJson("/cores"),
      apiJson("/tamanhos"),
    ]);

    const pSel = document.getElementById("produto_id");
    pSel.innerHTML = produtos.map(p=>`<option value="${p.id}">${p.id} - ${p.nome}</option>`).join("");

    const cSel = document.getElementById("cor_id");
    cSel.innerHTML = cores.map(c=>`<option value="${c.id}">${c.nome}</option>`).join("");

    const tSel = document.getElementById("tamanho_id");
    tSel.innerHTML = tamanhos.map(t=>`<option value="${t.id}">${t.nome}</option>`).join("");
  }

  async function carregarPV() {
    const list = await apiJson("/produto-variacoes");
    const tbody = document.getElementById("pvList");
    tbody.innerHTML = "";
    list.forEach(v => {
      tbody.innerHTML += `
        <tr>
          <td>${v.id}</td>
          <td>${v.Produto?.nome || v.produto_id}</td>
          <td>${v.Cor?.nome || v.cor_id}</td>
          <td>${v.Tamanho?.nome || v.tamanho_id}</td>
          <td>${v.quantidade}</td>
          <td>${v.imagem_url ? `<img src="${v.imagem_url}" width="40">` : "—"}</td>
          <td><button class="delete-btn" onclick="delPV(${v.id})">Excluir</button></td>
        </tr>`;
    });
  }

  document.getElementById("formPV").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData();
    fd.append("produto_id", document.getElementById("produto_id").value);
    fd.append("cor_id", document.getElementById("cor_id").value);
    fd.append("tamanho_id", document.getElementById("tamanho_id").value);
    fd.append("quantidade", document.getElementById("quantidade").value);
    const f = document.getElementById("imagem_var").files[0];
    if (f) fd.append("imagem", f); // o controller aceita "imagem" no multipart

    await apiMultipart("/produto-variacoes", fd, { method: "POST" });
    (document.getElementById("formPV")).reset();
    carregarPV();
  });

  window.delPV = async (id) => {
    await apiJson(`/produto-variacoes/${id}`, { method: "DELETE" });
    carregarPV();
  };

  (async function init() {
    await carregarCombos();
    await carregarPV();
  })();
</script>
