<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Produtos</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main>
    <h2>Gerenciar Produtos com Cores e Tamanhos</h2>

    <form id="produtoForm" enctype="multipart/form-data">
      <input type="hidden" id="produto_id" />
      <label>Nome</label><input id="nome" required />
      <label>Descrição</label><textarea id="descricao" required></textarea>
      <label>Preço</label><input id="preco" type="number" step="0.01" required />
      <label>Estoque</label><input id="estoque" type="number" required />
      <label>Categoria</label><select id="categoria_id" required></select>
      <label>Marca</label><select id="marca_id" required></select>

      <h3>Variações (Cor + Tamanho)</h3>
      <label>Cor</label><select id="cor-select"></select>
      <label>Tamanho</label><select id="tamanho-select"></select>
      <label>Quantidade</label><input id="quantidade-var" type="number" min="1" />
      <button type="button" id="btnAddVar">Adicionar Variação</button>

      <ul id="variacoes-list"></ul>

      <label>Imagem (produto)</label><input id="imagem" type="file" accept="image/*" />
      <label>Vídeo (produto)</label><input id="video" type="file" accept="video/*" />

      <button type="submit" id="submitBtn">Cadastrar</button>
    </form>

    <div class="table-container">
      <h3>Produtos Cadastrados</h3>
      <table>
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Preço</th><th>Estoque</th><th>Imagem</th><th>Vídeo</th><th>Ações</th></tr>
        </thead>
        <tbody id="produtoList"></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    import { apiJson, apiMultipart } from "/js/api.js";

    let variacoesSelecionadas = [];
    let produtosData = [];

    async function carregarProdutos() {
      produtosData = await apiJson("/produtos");
      const tbody = document.getElementById("produtoList");
      tbody.innerHTML = "";
      produtosData.forEach(p => {
        tbody.innerHTML += `
          <tr>
            <td>${p.id}</td>
            <td>${p.nome}</td>
            <td>R$ ${Number(p.preco).toFixed(2)}</td>
            <td>${p.estoque}</td>
            <td>${p.imagem_url ? `<img src="${p.imagem_url}" width="50">` : "—"}</td>
            <td>${p.video_url ? `<a href="${p.video_url}" target="_blank">ver</a>` : "—"}</td>
            <td>
              <button onclick="editarProduto(${p.id})">Editar</button>
              <button onclick="deletarProduto(${p.id})">Excluir</button>
            </td>
          </tr>`;
      });
    }

    async function carregarCores() {
      const cores = await apiJson("/cores");
      const sel = document.getElementById("cor-select");
      sel.innerHTML = cores.map(c => `<option value="${c.id}">${c.nome} (${c.codigo_hex})</option>`).join("");
    }
    async function carregarTamanhos() {
      const t = await apiJson("/tamanhos");
      const sel = document.getElementById("tamanho-select");
      sel.innerHTML = t.map(x => `<option value="${x.id}">${x.nome}</option>`).join("");
    }
    async function carregarMarcas() {
      const m = await apiJson("/marcas");
      const sel = document.getElementById("marca_id");
      sel.innerHTML = m.map(x => `<option value="${x.id}">${x.nome}</option>`).join("");
    }
    async function carregarCategorias() {
      const c = await apiJson("/categorias");
      const sel = document.getElementById("categoria_id");
      sel.innerHTML = c.map(x => `<option value="${x.id}">${x.nome}</option>`).join("");
    }

    document.getElementById("btnAddVar").addEventListener("click", () => {
      const corSel = document.getElementById("cor-select");
      const tamSel = document.getElementById("tamanho-select");
      const qtd = Number(document.getElementById("quantidade-var").value);
      if (!qtd || qtd <= 0) return alert("Quantidade inválida.");

      const cor_id = Number(corSel.value);
      const tamanho_id = Number(tamSel.value);
      if (variacoesSelecionadas.some(v=>v.cor_id===cor_id && v.tamanho_id===tamanho_id)) {
        return alert("Variação já adicionada.");
      }
      variacoesSelecionadas.push({ cor_id, tamanho_id, quantidade: qtd });

      const li = document.createElement("li");
      li.id = `var-${cor_id}-${tamanho_id}`;
      li.innerHTML = `
        ${corSel.options[corSel.selectedIndex].text} / ${tamSel.options[tamSel.selectedIndex].text} - Qtd: ${qtd}
        <input type="file" id="imgvar_${cor_id}_${tamanho_id}" accept="image/*">
        <button type="button" onclick="removerVariacao(${cor_id},${tamanho_id})">Remover</button>`;
      document.getElementById("variacoes-list").appendChild(li);
      document.getElementById("quantidade-var").value = "";
    });

    window.removerVariacao = (cor_id, tamanho_id) => {
      variacoesSelecionadas = variacoesSelecionadas.filter(v => !(v.cor_id===cor_id && v.tamanho_id===tamanho_id));
      const el = document.getElementById(`var-${cor_id}-${tamanho_id}`);
      if (el) el.remove();
    };

    window.deletarProduto = async (id) => {
      await apiJson(`/produtos/${id}`, { method: "DELETE" });
      carregarProdutos();
    };

    window.editarProduto = (id) => {
      const p = produtosData.find(x => x.id === id);
      if (!p) return;

      document.getElementById("produto_id").value = p.id;
      document.getElementById("nome").value = p.nome;
      document.getElementById("descricao").value = p.descricao || "";
      document.getElementById("preco").value = p.preco;
      document.getElementById("estoque").value = p.estoque;
      document.getElementById("categoria_id").value = p.categoria_id;
      document.getElementById("marca_id").value = p.marca_id;

      variacoesSelecionadas = [];
      document.getElementById("variacoes-list").innerHTML = "";
      (p.ProdutoVariacaos || []).forEach(v => {
        variacoesSelecionadas.push({ cor_id: v.cor_id, tamanho_id: v.tamanho_id, quantidade: v.quantidade });
        const li = document.createElement("li");
        li.id = `var-${v.cor_id}-${v.tamanho_id}`;
        li.innerHTML = `
          Cor ID ${v.cor_id} / Tam ID ${v.tamanho_id} - Qtd: ${v.quantidade}
          <input type="file" id="imgvar_${v.cor_id}_${v.tamanho_id}" accept="image/*">
          <button type="button" onclick="removerVariacao(${v.cor_id},${v.tamanho_id})">Remover</button>`;
        document.getElementById("variacoes-list").appendChild(li);
      });

      document.getElementById("submitBtn").textContent = "Atualizar";
    };

    document.getElementById("produtoForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const form = new FormData();
      form.append("nome", document.getElementById("nome").value);
      form.append("descricao", document.getElementById("descricao").value);
      form.append("preco", document.getElementById("preco").value);
      form.append("estoque", document.getElementById("estoque").value);
      form.append("categoria_id", document.getElementById("categoria_id").value);
      form.append("marca_id", document.getElementById("marca_id").value);

      const img = document.getElementById("imagem").files[0];
      if (img) form.append("imagem", img);
      const vid = document.getElementById("video").files[0];
      if (vid) form.append("video", vid);

      form.append("variacoes", JSON.stringify(variacoesSelecionadas));

      // anexar imagens de variação com o mesmo padrão do Postman/back:
      variacoesSelecionadas.forEach(v => {
        const f = document.getElementById(`imgvar_${v.cor_id}_${v.tamanho_id}`)?.files?.[0];
        if (f) form.append(`imagem_variacao_${v.cor_id}_${v.tamanho_id}`, f);
      });

      const id = document.getElementById("produto_id").value;
      const url = id ? `/produtos/${id}` : "/produtos";
      const method = id ? "PUT" : "POST";

      await apiMultipart(url, form, { method });

      // reset
      (document.getElementById("produtoForm")).reset();
      document.getElementById("produto_id").value = "";
      document.getElementById("variacoes-list").innerHTML = "";
      variacoesSelecionadas = [];
      document.getElementById("submitBtn").textContent = "Cadastrar";
      carregarProdutos();
    });

    (async function init(){
      await Promise.all([carregarCores(), carregarTamanhos(), carregarMarcas(), carregarCategorias()]);
      await carregarProdutos();
    })();
  </script>
</body>
</html>
